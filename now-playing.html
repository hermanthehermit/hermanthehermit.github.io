
<!DOCTYPE html>   
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Last Played from Last.fm</title>
	<link rel="stylesheet" href="/static/css/normalize.min.css">
	<link rel="stylesheet" href="style.min.css?v1">
	<style>
		.artwork {
			background-image: url("");
		}
	</style>
	<script>
		let playing = false;
	
		function requestUpdate() {
			let url = `https://ws.audioscrobbler.com/2.0/?api_key=b0cb4aaf8ae49ba23e32e452eacc5750&method=user.getRecentTracks&user=bbeyer&extended=1&limit=1&format=json`;

			let request = new Request(url, {
				"method": "GET",
			});

			return fetch(request);
		}
		
		function successHandler(value) {
			value.json().then(data => {
				//console.log(data);
				
				let track = data.recenttracks.track[0];
				let title = data.recenttracks.track[0].name;
				let old_title = document.querySelector(".track");

				console.log(title);
				console.log(old_title.innerText);

				if (track["@attr"] == undefined) {
					if (playing) {
						// Stop Playing
						console.log("Not playing anything.");
						playing = false;
						window.location.reload(1);
					}
				} else if (playing == false) {
					// Start Playing
					console.log("Now playing.");
					playing = true;
				} 
				if(title && old_title.innerText){
					if(title != old_title.innerText) {
						// Refresh page.
						window.location.reload(1);
					}
				}
			}, reason => {
		
			})
			setTimeout(tick, 30000);
		}
		
		function failureHandler(reason) {
			console.log("Last.fm query failed:", reason);
			setTimeout(tick, 60000);
		}
		
		function tick() {
			let rq = requestUpdate();
			rq.then(successHandler, failureHandler);
			rq.catch(failureHandler);
		}
		
		(function() {
			tick();
		})();
	</script>
</head>
<body>
	<div id="container" class="last_played">	
			<div class="user"></div>
			<div class="stat_box">
				<div class="header">scrobbles</div>
				<div class="scrobbles"></div>
			</div>
			<div class="stat_box">
				<div class="header">last played</div>
				<div class="play_box">
				<div class="track"></div>
				<div class="artist"></div>
				</div>
			</div>
			<div class="list">Top Albums - Last 7 Days</div>
			<div class="albums">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
				<img class="top_albums" src="">
			</div>			
	</div>
</body>
</html>

