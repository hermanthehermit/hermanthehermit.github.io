
<!DOCTYPE html>   
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Last Played from Last.fm</title>
	<link rel="stylesheet" href="/static/css/normalize.min.css">
	<link rel="stylesheet" href="style.min.css?v1">
	<style>
		.artwork {
			background-image: url("https://lastfm.freetls.fastly.net/i/u/600x600/d5bc0f79e06ab43548e000474ef3e33d.jpg");
		}
	</style>
	<script>
		let playing = false;
	
		function requestUpdate() {
			let url = `https://ws.audioscrobbler.com/2.0/?api_key=b0cb4aaf8ae49ba23e32e452eacc5750&method=user.getRecentTracks&user=bbeyer&extended=1&limit=1&format=json`;

			let request = new Request(url, {
				"method": "GET",
			});

			return fetch(request);
		}
		
		function successHandler(value) {
			value.json().then(data => {
				//console.log(data);
				
				let track = data.recenttracks.track[0];
				let title = data.recenttracks.track[0].name;
				let old_title = document.querySelector(".track");

				console.log(title);
				console.log(old_title.innerText);

				if (track["@attr"] == undefined) {
					if (playing) {
						// Stop Playing
						console.log("Not playing anything.");
						playing = false;
						window.location.reload(1);
					}
				} else if (playing == false) {
					// Start Playing
					console.log("Now playing.");
					playing = true;
				} 
				if(title && old_title.innerText){
					if(title != old_title.innerText) {
						// Refresh page.
						window.location.reload(1);
					}
				}
			}, reason => {
		
			})
			setTimeout(tick, 30000);
		}
		
		function failureHandler(reason) {
			console.log("Last.fm query failed:", reason);
			setTimeout(tick, 60000);
		}
		
		function tick() {
			let rq = requestUpdate();
			rq.then(successHandler, failureHandler);
			rq.catch(failureHandler);
		}
		
		(function() {
			tick();
		})();
	</script>
</head>
<body>
	<div id="container" class="last_played">	
			<div class="user">Brian Beyer</div>
			<div class="stat_box">
				<div class="header">scrobbles</div>
				<div class="scrobbles">55,765</div>
			</div>
			<div class="stat_box">
				<div class="header">last played</div>
				<div class="play_box">
				<div class="track">Just To Say</div>
				<div class="artist">Kacy Hill</div>
				</div>
			</div>
			<div class="list">Top Albums - Last 7 Days</div>
			<div class="albums">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/7d1b3bb68de6e3245e2af83a53bb2670.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/e88d98d991a5072a9b599950b9af837d.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/0bc8948eb2c1ed4fc91ecdf067d9ae73.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/65849a4d18a307381e8484803c011dad.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/9b17e5f13654b06badddb9912e06e72e.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/cbfed2aeb1c6e0aa55968148db85fa14.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/0fda8872b4fdbfcab41e3b905ddea30d.png">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/c9e0b05070b3495b711cd26f74f87bbc.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/a0dc849ac5252d42bc230dc825991d8b.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/0457ce75aabffbce6098b737fae65344.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/57ce99c34415e3f951f5df99810d106e.jpg">
				<img class="top_albums" src="https://lastfm.freetls.fastly.net/i/u/300x300/e69e0d4c24ccc2400e4b12ae8541b55a.jpg">
			</div>			
	</div>
</body>
</html>

